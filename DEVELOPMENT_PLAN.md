# 水果供应链全流程管理系统 - 开发计划

## 项目概述

本项目是一个水果供应链全流程管理系统，涵盖采购、运输、仓储、打包发货等完整业务流程，以及成本核算、追溯管理等核心管控功能。

**技术栈**：
- **前端**：React 18 + Tailwind CSS + shadcn/ui + Vite
- **后端**：Node.js + Express/Fastify
- **数据库**：Supabase (PostgreSQL)
- **存储**：Supabase Storage
- **其他**：Zustand（状态管理）、TanStack Query、React Hook Form

---

## 一、系统模块清单与优先级

### P1 优先级（第 1-4 周）- 核心业务闭环

| 模块 | 功能清单 | 预计工作量 |
|------|--------|---------|
| **采购管理** | 供应商管理、采购订单、AI 语义分析录入、到货验收 | 3 周 |
| **仓储管理** | 入库、库存、出库、盘点、临期预警 | 3 周 |
| **打包发货** | 订单、打包、发货管理 | 2 周 |
| **成本核算** | 批次成本、多维度成本核算 | 2 周 |
| **系统管理** | 系统配置、数据备份恢复 | 1 周 |

### P2 优先级（第 5-8 周）- 核心管控

| 模块 | 功能清单 | 预计工作量 |
|------|--------|---------|
| **一码一物追溯** | 编码生成、数据关联、扫码查询 | 2 周 |
| **物料管理** | 基础信息、采购、领用、库存 | 1.5 周 |
| **消息通知** | 多渠道通知、预警管理 | 1 周 |
| **采购优化** | 采购计划、到货验收完善 | 1 周 |
| **仓储优化** | 盘点管理、成本分摊 | 1 周 |

### P3 优先级（第 9-10 周）- 补充功能

| 模块 | 功能清单 | 预计工作量 |
|------|--------|---------|
| **客户管理** | 信息管理、交易、信用管理 | 1.5 周 |
| **人员管理** | 信息管理、排班、绩效 | 1.5 周 |
| **运输管理（简化）** | 司机管理、订单、成本 | 1.5 周 |
| **发货优化** | 发货成本核算、费用分摊 | 1 周 |
| **成本分析** | 利润分析、成本趋势 | 1 周 |

### P4 优先级（第 11-12 周）- 高级功能

| 模块 | 功能清单 | 预计工作量 |
|------|--------|---------|
| **权限管理** | 角色、权限分配、操作日志 | 1.5 周 |
| **产品素材** | 上传、分类、审核、查询 | 1 周 |
| **数据分析** | 报表、图表、导出 | 2 周 |
| **性能优化** | 压力测试、性能调优 | 1 周 |

---

## 二、数据库核心表结构

### 2.1 基础主表
```sql
-- 用户、角色、权限
users
roles
permissions
user_roles
role_permissions
suppliers (供应商/农场/农户)
customers
warehouses
```

### 2.2 采购模块
```sql
purchase_plans
purchase_orders
purchase_order_items
purchase_costs (采购成本汇总)
purchase_cost_details (采购成本明细)
purchase_receipts (采购验收)
```

### 2.3 运输模块
```sql
transport_orders
transport_staff (外包司机)
transport_tracking
transport_verification
transport_costs
```

### 2.4 仓储模块
```sql
warehouse_locations (库位)
inventory (库存主表)
inbound_orders (入库单)
outbound_orders (出库单)
inventory_batches (库存批次)
inventory_check (盘点)
inventory_alerts (库存预警)
```

### 2.5 打包发货模块
```sql
sales_orders
packing_orders
packing_details
shipping_orders
shipping_tracking
```

### 2.6 成本核算模块
```sql
cost_collection (成本归集)
cost_allocation (成本分配)
batch_costs (批次成本)
product_costs (产品成本)
profitability_analysis (利润分析)
```

### 2.7 追溯管理模块
```sql
product_codes (二维码/条码)
traceability_data (追溯数据)
traceability_logs
```

### 2.8 物料管理模块
```sql
materials
material_inventory
material_requisition
```

### 2.9 人员管理模块
```sql
employees
employee_schedule
attendance
performance_metrics
```

### 2.10 系统管理模块
```sql
system_config
data_dictionary
operation_logs
notifications
```

---

## 三、分阶段详细开发计划

### 第一阶段（第 1-4 周）：基础搭建与核心业务开发

#### 第 1 周：项目初始化与基础架构
- **前端**: React + Tailwind + shadcn 项目初始化，路由框架，API 请求配置
- **后端**: Node.js 项目初始化，Supabase 连接，认证中间件，基础 API 框架
- **数据库**: 创建基础用户、角色、权限、供应商表
- **文档**: API 接口文档（Swagger）

**交付物**: 项目骨架、基础认证系统可用

#### 第 2 周：采购管理核心功能
- **供应商管理**: 增删改查、资质审核
- **采购订单基础**: 订单列表、新增、详情
- **AI 语义分析框架**: 文本和对话式录入、基础解析逻辑
- **数据库**: 购采模块表创建

**交付物**: 采购订单基础功能可用、AI 录入框架完成

#### 第 3 周：仓储和打包发货核心功能
- **仓储**: 入库、库存、出库、临期预警
- **打包发货**: 订单、打包、发货管理
- **数据库**: 仓储、发货模块表创建

**交付物**: 仓储和打包发货基础流程可用

#### 第 4 周：成本核算与系统集成
- **成本核算**: 批次成本计算、成本查询
- **系统配置**: 基础参数、成本规则配置
- **集成测试**: 采购→仓储→发货全流程打通
- **性能优化**: 基础性能调优

**交付物**: 核心业务闭环完整、成本数据流通

---

### 第二阶段（第 5-8 周）：核心管控功能开发

#### 第 5-6 周：追溯、物料、通知管理
- **一码一物**: 编码生成、数据关联、扫码查询
- **物料管理**: 基础信息、采购、领用、库存
- **消息通知**: 多渠道通知、预警配置

**交付物**: 追溯管理、物料管理完整功能

#### 第 7 周：采购和仓储功能完善
- **采购计划**: 计划制定、调整审批
- **到货验收**: 验收单、质检、流程处理
- **盘点管理**: 定期盘点、差异处理

**交付物**: 采购和仓储高级功能完成

#### 第 8 周：第二阶段测试
- 全系统集成测试
- UAT 用户验收测试
- 文档和培训准备

**交付物**: 管控功能完整版本

---

### 第三阶段（第 9-10 周）：补充功能开发

#### 第 9 周：客户、人员、运输管理
- **客户管理**: 信息、交易、信用管理
- **人员管理**: 信息、排班、绩效
- **运输管理**: 司机、订单、成本（简化版）

**交付物**: 补充管理模块完成

#### 第 10 周：成本分析优化
- **发货成本**: 成本分摊逻辑
- **利润分析**: 多维度分析
- **全系统集成测试**

**交付物**: 全功能初步版本

---

### 第四阶段（第 11-12 周）：优化迭代与上线

#### 第 11 周：权限、素材、数据分析
- **权限管理**: 角色配置、权限分配、操作日志
- **产品素材**: 上传、分类、审核、查询
- **数据分析**: 核心报表、图表展示、导出
- **性能和安全测试**

**交付物**: 高级功能完成、性能达标

#### 第 12 周：上线准备
- **最终 UAT 测试**: 全岗位用户验收
- **用户培训**: 操作手册、视频教程
- **系统部署**: 生产环境部署
- **运维方案**: 监控、告警、巡检

**交付物**: 正式上线版本

---

## 四、前端项目结构

```
src/
├── components/              # React 组件
│   ├── common/             # Header、Sidebar、Modal 等通用组件
│   ├── purchase/           # 采购模块组件
│   ├── warehouse/          # 仓储模块组件
│   ├── shipping/           # 打包发货模块组件
│   ├── cost/               # 成本核算模块组件
│   ├── traceability/       # 追溯模块组件
│   └── [其他模块]
├── pages/                  # 页面级组件
│   ├── Login.tsx
│   ├── Dashboard.tsx
│   └── [各模块页面]
├── hooks/                  # 自定义 Hook
│   ├── useAuth.ts
│   ├── usePurchase.ts
│   └── [其他 Hook]
├── services/               # API 请求服务
│   ├── auth.service.ts
│   ├── purchase.service.ts
│   └── [其他服务]
├── store/                  # 状态管理（Zustand）
│   ├── authStore.ts
│   ├── purchaseStore.ts
│   └── [其他 store]
├── types/                  # TypeScript 类型定义
│   ├── auth.ts
│   ├── purchase.ts
│   └── [其他类型]
├── utils/                  # 工具函数
│   ├── request.ts          # API 请求配置
│   ├── validators.ts       # 数据验证
│   └── formatters.ts       # 格式化函数
├── styles/                 # 全局样式
└── App.tsx
```

---

## 五、后端项目结构

```
backend/
├── src/
│   ├── config/            # 配置文件
│   │   ├── database.ts
│   │   ├── env.ts
│   │   └── supabase.ts
│   ├── controllers/       # 控制器层
│   │   ├── auth.controller.ts
│   │   ├── purchase.controller.ts
│   │   └── [其他控制器]
│   ├── services/          # 服务层（核心业务逻辑）
│   │   ├── auth.service.ts
│   │   ├── purchase.service.ts
│   │   └── [其他服务]
│   ├── repositories/      # 数据访问层
│   │   ├── purchase.repository.ts
│   │   └── [其他仓库]
│   ├── middleware/        # 中间件
│   │   ├── auth.middleware.ts
│   │   ├── error.middleware.ts
│   │   └── logger.middleware.ts
│   ├── routes/            # 路由
│   │   ├── auth.routes.ts
│   │   ├── purchase.routes.ts
│   │   └── [其他路由]
│   ├── types/             # TypeScript 类型
│   │   ├── auth.ts
│   │   ├── purchase.ts
│   │   └── [其他类型]
│   ├── utils/             # 工具函数
│   │   ├── errors.ts
│   │   ├── validators.ts
│   │   └── helpers.ts
│   └── app.ts            # Express 应用主文件
├── tests/                 # 测试文件
├── .env.example
├── package.json
└── tsconfig.json
```

---

## 六、关键技术方案

### 6.1 AI 语义分析录入（采购订单）

**流程**：
1. 采购人员输入文本或对话
2. LLM 解析文本，提取关键信息
3. 系统自动映射至标准化字段
4. 数据验证和校验（完整性、合理性）
5. 数据回显并确认提交

**集成方案**：
- 使用 OpenAI API 或 Claude API 进行语义解析
- 预设采购成本字段词典
- 支持批量数据聚合和多轮对话整合

### 6.2 成本核算核心逻辑

```
批次总成本 = 采购成本 + 运输成本 + 仓储成本 + 打包成本

每箱成本 = (批次总成本 / 总箱数) + 分摊的其他成本

每车成本 = (所装载产品的每箱成本总和) + 整车运输费

利润 = 销售价格 - 总成本
```

### 6.3 追溯链路

```
采购订单 → 库存批次 → 出库订单 → 发货订单 → 客户收货
   ↓         ↓          ↓          ↓
二维码 → 追溯数据 → 链路传递 → 最终交付
```

### 6.4 实时功能

- **Supabase Realtime**: 库存变化、预警推送
- **WebSocket**: 订单状态实时更新
- **消息队列**: 异步任务处理

### 6.5 数据安全

- **行级安全（RLS）**: Supabase RLS 实现基于角色的数据访问控制
- **数据加密**: 敏感信息（客户、成本、财务）加密存储
- **API 认证**: JWT Token 验证
- **操作审计**: 完整的操作日志记录

---

## 七、性能和可靠性指标

| 指标 | 目标值 |
|------|--------|
| 页面加载时间 | ≤ 2 秒 |
| 扫码识别响应 | ≤ 0.5 秒 |
| 报表生成时间 | ≤ 5 秒 |
| 并发用户 | ≥ 50 用户 |
| 核心业务并发 | ≥ 20 用户 |
| 系统可用性 | ≥ 99.5% |
| 核心模块可用性 | ≥ 99.8% |

---

## 八、关键里程碑

| 时间 | 里程碑 | 验收指标 |
|------|--------|----------|
| 第 4 周末 | 核心业务基础版本 + 成本核算 | 采购→库存→发货闭环完整 |
| 第 8 周末 | 管控功能完整版本 | 追溯、物料、通知功能可用 |
| 第 10 周末 | 全功能初步版本 | 客户、人员、运输模块完成 |
| 第 12 周末 | 正式上线版本 | 权限、素材、分析完成，性能达标 |

---

## 九、风险管理

| 风险 | 影响 | 缓解方案 |
|------|------|--------|
| AI 语义解析准确度不足 | 采购数据质量 | 预留人工审核流程，逐步优化词典 |
| Supabase RLS 配置复杂 | 权限管控 | 前期充分测试，预留充足时间 |
| 成本计算逻辑复杂 | 财务准确性 | 与财务部门充分沟通，多轮验证 |
| 数据量大导致性能下降 | 用户体验 | 分页、缓存、数据库优化 |

---

## 十、协作和沟通

- **每周进度评审**: 每周 1 次进度同步会
- **需求澄清**: 及时与相关岗位沟通，解决歧义
- **用户反馈**: 核心业务完成后邀请用户试用
- **文档更新**: 每个阶段完成后更新相关文档

---

**文档维护**: 最后更新时间：2025-12-23
